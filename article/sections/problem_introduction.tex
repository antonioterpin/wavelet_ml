\section{Steel surfaces defect detection}
    \subsection{Problem statement}
        \par{
            \emph{Given a set of steel surfaces images with the description of their defective areas, learn to detect defective pixels in new pictures.}
        }
        \begin{figure}
            \includegraphics[width=\linewidth]{graphics/architecture/architecture-input}
            \vskip .05cm
            \includegraphics[width=\linewidth]{graphics/architecture/architecture-output}
            \caption{Detection process input and output.}\label{fig:exampledetection}
        \end{figure}
        \par{
            The surfaces may have more disjunct defective areas, and there are four defective classes, described in \ref{subsection:defects}.
        }
        \par{
            For each of this areas, a thorough characterization of the member pixels must be provided, along with the class of the defect pictured in the considered region.
        }
        \par{
            Defective pixels are described using a Run Length Encoding (RLE) approach. The rationale is that an efficient way to store pixel-wide information is needed, and it is reasonable to believe that many defective pixels will be adjacent.
        }
        \par{
            To do so, the binary matrix describing interesting pixels is firstly vectorized column-wide, i.e. each column vector is appended to the previous.
        }
        \par{
            Secondly, pixels are enumerated in this vectorized map.
        }
        \par{
            Finally, the rle algorithm is used on the indices of the cosidered pixels.
        }
        \par{
            \begin{BVerbatim}

Example:

    Suppose the ones in the below 
    matrix need to be encoded:
     _       _
    | 1 0 1 1 |
    | 1 1 1 0 |
    | 0 1 1 0 |
     -       -

    The interested cells, expressed 
    as (x, y) coordinates, are:

    [(1, 1) (1, 2) (2, 2) (2, 3)
        (3, 1) (3, 2) (3, 3) (4, 1)]
    
    The vectorized matrix is:

    [1 1 0 0 1 1 1 1 1 1 0 0]

    Which can be encoded as:

    "1 2 4 6"
           
            \end{BVerbatim}
        }
        \par{
            An optimized implementation in \texttt{MATLAB} of both the rle encoding and decoding scheme described is proposed in \cite{antonioterpin:github}.
        }
        \par{
            A visual description of the end to end process is given in figure \ref{fig:exampledetection}, where defective areas have been highlighted with different colors, depending on the defect class.
        }
        \par{
            A mathematical description of the task is:
        }
        \par{
            Given a \emph{training set} $\left(\underline{\underline{\mathbf{X}}}_{train}, \underline{\mathbf{y}}_{train}\right)$ and a \emph{test set} $\left(\underline{\underline{\mathbf{X}}}_{test}, \underline{\mathbf{y}}_{test}\right)$, the goal is to build a \emph{trainer} system $\mathcal{T}$ and a \emph{predictor} function $\mathcal{P}$ such that:
            \begin{equation*}
                \underline{\underline{\mathbf{\Theta}}} = \mathcal{T}\left(\underline{\underline{\mathbf{X}}}_{train}, \underline{\mathbf{y}}_{train}\right);\quad \lvert \mathcal{P}\left(\underline{\underline{\mathbf{X}}}_{test}; \underline{\underline{\mathbf{\Theta}}}\right) - \underline{\mathbf{y}}_{test} \rvert \rightarrow 0
            \end{equation*}
        }
        \par{
            Both the trainer and the predictor are implemented through deep learning tecniques and they are described in \ref{section:architecture}.
        }

    \subsection{Defect analysis}\label{subsection:defects}
        \par{
            The dataset is concerned with flat steel sheet, which production process is especially delicate and structured in many phases.
        }
        \par{
            Therefore, there are numerous defects classified in literature \cite{defects:64common,defects:mainlinemetals}. Hence, many of the traditional types may have been grouped together in the four classes given. However, in this section a plausible explanation of each defect class is provided.
        }
        \par{
            The fundamental observation, however, is that some defects have a global origin, i.e. they are due to a flawed machinery, therefore is reasonable that a local classifier would miss some important details.
        }
        % \par{
        %     One of the main stage of the production process is rolling \cite{wiki:rolling, defects:rolling}, which is the procedure of plastically deforming steel by passing it between rolls. Therefore, the steel is subjected to high compressive stresses as a result of the friction between the rolls and the metal surface.
        % }
        % \par{
        %     The semi-finished products of casting are named \emph{bloom}, \emph{billet} and \emph{slab}. The former is the product of the first breakdown of the ingot, the second is obtained from a further reduction by hot rolling, and the latter is obtained by rolling the ingot or the bloom.
        % }
        % \par{
        %     Rolling mill products are called \emph{plate}, \emph{sheet}, \emph{strip} based on their size.
        % }
        % \par{
        %     The plate has a thickness greater then $\SI{6}{\mm}$, whereas both sheet and strip are smaller. However, the latters are distinguished by their width. Sheets width is larger then $\SI{600}{\mm}$, whereas strips width is not.
        % }
        \subsubsection{Defect class \#1}\label{section:defect-class-1}
            \par{
                The first type of defect has not been classified yet into one of the classes found in literature.
            }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class1surface}
                \vskip .05cm
                \includegraphics[width=\linewidth]{graphics/defects/class1surface-highlighted}
                \caption{Steel surface with defect class \#1.}\label{fig:defects:surface-1}
            \end{figure}
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/nregions-class1}
                \caption{Number of defects of class 1 per defective surface.}\label{fig:nregions-1}
            \end{figure}
            \par{
                However, it is a glaring example of burst defect, indeed it is reasonable to expect such defect to repeat multiple times on the same surface, as deducible from the histogram in figure \ref{fig:nregions-1}.
            }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class1shape}
                \caption{Shape distribution for defect class \#1.}\label{fig:defects:shape-1}
            \end{figure}
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/class1-height-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class1-height-distribution-log}
                \includegraphics[width=\linewidth]{graphics/defects/class1-length-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class1-length-distribution-log}
                % \includegraphics[width=\linewidth]{graphics/defects/class1-gaussian}
                \caption{Defect class \#1 dimensions distribution.}\label{fig:defects:gaussian-1}
            \end{figure}
            \par{
                An example of surface with a burst of class \#1 defects is visible in illustration \ref{fig:defects:surface-1}. The shape distribution of the defect is illustrated in picture \ref{fig:defects:shape-1}.
            }
            \par{
                This is drawn by super-position of all the defects of the same type, centered in the middle of the figure, and counting the relative frequencies of each pixel.
            }
            \par{
                Defect \#1 dimensions distribution is shown in \ref{fig:defects:gaussian-1}. 
            }
            \begin{table}
                \centering
                \begin{tabular}{|c|c|c|}
                    \hline
                    \textbf{Length distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/lengthDistribution1.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                    \textbf{Height distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/heightDistribution1.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                \end{tabular}
                \vspace{0.25cm}
                \caption{hypotheses test results on class \#1.}\label{table:hypotheses-test-1}
            \end{table}
            \par{
                In table \ref{table:hypotheses-test-1} are shown the results of some distribution hypothesis tests. The null hypotheses are data following a particular distribution (e.g. Lognormal, Normal, Weibull), with their parameters tuned using the best sample estimators. It is visible that it is not possible to infer the distribution, and it is eventually better to use a kernel distribution.
            }
            \par{
                Therefore, no information on the tuning of the architecture hyperparameters has been extrapolated from data distribution.
            }
        \subsubsection{Defect class \#2}\label{section:defect-class-2}
            \par{
                Defects of class \#2 usually appears near the transversal edge, hence, they are probably edge laminations, since they are also visually similar.
            }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class2surface}
                \vskip .05cm
                \includegraphics[width=\linewidth]{graphics/defects/class2surface-highlighted}
                \caption{Steel surface with defect class \#2.}\label{fig:defects:surface-2}
            \end{figure}
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/nregions-class2}
                \caption{Number of defects of class 2 per defective surface.}\label{fig:nregions-2}
            \end{figure}
            \par{
                These defects are local, since they are usually near the edge. Indeed, from the histogram in figure \ref{fig:nregions-2} is visible that they occur only a small limited number of times on the same surface.
            }
            % \par{
            %     This defects are due to the overcooling of the slab off of the caster. The coil mill edges looks like a continuous or semi-continuous line of slivers.
            % }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class2shape}
                \caption{Shape distribution for defect class \#2.}\label{fig:defects:shape-2}
            \end{figure}
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/class2-height-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class2-height-distribution-log}
                \includegraphics[width=\linewidth]{graphics/defects/class2-length-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class2-length-distribution-log}
                % \includegraphics[width=\linewidth]{graphics/defects/class2-gaussian}
                \caption{Defect class \#2 dimensions distribution.}\label{fig:defects:gaussian-2}
            \end{figure}
            \par{
                In figure \ref{fig:defects:surface-2} an example of surface with a defect of this type is shown. The shape distribution of the defect is illustrated in picture \ref{fig:defects:shape-2}.
            }
            \par{
                Defect \#2 dimensions distribution is shown in \ref{fig:defects:gaussian-2}. 
            }
            \begin{table}
                \centering
                \begin{tabular}{|c|c|c|}
                    \hline
                    \textbf{Length distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/lengthDistribution2.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                    \textbf{Height distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/heightDistribution2.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                \end{tabular}
                \vspace{0.25cm}
                \caption{hypotheses test results on class \#2.}\label{table:hypotheses-test-2}
            \end{table}
            \par{
                In table \ref{table:hypotheses-test-2} are shown the results of some distribution hypothesis tests. It is clear that it is not possible to model the height with any distribution, whereas the length may be modeled with the kernel distribution. 
            }
        \subsubsection{Defect class \#3}\label{section-defect-class-3}
            \par{
                The mill rolls should be perfectly parallel to correctly flatten the steel. When this is not the case, a stress pattern arises, with tension along the centreline.
            }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class3surface}
                \vskip .05cm
                \includegraphics[width=\linewidth]{graphics/defects/class3surface-highlighted}
                \caption{Steel surface with defect class \#3.}\label{fig:defects:surface-3}
            \end{figure}
            \par{
                Defects of class \#3 are probably rolling defects, in particular their repetitive pattern along the centreline is a symptom of \emph{zipper cracks}, i.e. centre line cracking. This is another patent example of burst defect.
            }
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/nregions-class3}
                \caption{Number of defects of class 3 per defective surface.}\label{fig:nregions-3}
            \end{figure}
            \par{
                The hypothesis of transversality of the presence of a defect of class \#3 over the surface is supported by the histogram in figure \ref{fig:nregions-3}. However, as extrapolated from a visual analysis (as an example, consider figure \ref{fig:defects:surface-3}), many defects of class \#3 are encoded together, since they are very near one another. Hence, many of these are considered as an atomic region.
            }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class3shape}
                \caption{Shape distribution for defect class \#3.}\label{fig:defects:shape-3}
            \end{figure}
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/class3-height-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class3-height-distribution-log}
                \includegraphics[width=\linewidth]{graphics/defects/class3-length-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class3-length-distribution-log}
                % \includegraphics[width=\linewidth]{graphics/defects/class3-gaussian}
                \caption{Defect class \#3 dimensions distribution.}\label{fig:defects:gaussian-3}
            \end{figure}
            \par{
                An example of surface affected by defects of class \#3 is shown in figure \ref{fig:defects:surface-3}. A single defect of class \#3 (i.e. a single crack) has usually the shape shown in picture \ref{fig:defects:shape-3}.
            }
            \par{
                Defect \#3 dimensions distribution is shown in \ref{fig:defects:gaussian-3}. 
            }
            \begin{table}
                \centering
                \begin{tabular}{|c|c|c|}
                    \hline
                    \textbf{Length distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/lengthDistribution3.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                    \textbf{Height distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/heightDistribution3.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                \end{tabular}
                \vspace{0.25cm}
                \caption{hypotheses test results on class \#3.}\label{table:hypotheses-test-3}
            \end{table}
            \par{
                In table \ref{table:hypotheses-test-3} are shown the results of some distribution hypothesis tests. Conclusions are the same discussed in \ref{section:defect-class-2}.
            }

        \subsubsection{Defect class \#4}\label{section-defect-class-4}
            \par{
                This defect class seems to be concerned with protrusions on the steel surface. The main typologies of protuberances in the given dataset are \emph{scabs} and \emph{blisters}.
            }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class4surface}
                \vskip .05cm
                \includegraphics[width=\linewidth]{graphics/defects/class4surface-highlighted}
                \caption{Steel surface with defect class \#4.}\label{fig:defects:surface-4}
            \end{figure}
            \par{
                Scabs are flattened protrusions, and they tend to be round or oval shaped and concentrated to only certain blooms or billets.
            }
            \par{
                Blisters, or gas porosities, are small bulges on the surface of the components and their dimension can vary. Some gasses may remain trapped inside the steel sheet. The high pressure due to the rolling process produces then protrusions on the surface.
            }
            \begin{figure}
                \includegraphics[width=\linewidth]{graphics/defects/class4shape}
                \caption{Shape distribution for defect class \#4.}\label{fig:defects:shape-4}
            \end{figure}
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/class4-height-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class4-height-distribution-log}
                \includegraphics[width=\linewidth]{graphics/defects/class4-length-distribution}
                % \includegraphics[width=\linewidth]{graphics/defects/class4-length-distribution-log}
                % \includegraphics[width=\linewidth]{graphics/defects/class4-gaussian}
                \caption{Defect class \#4 dimensions distribution.}\label{fig:defects:gaussian-4}
            \end{figure}
            \par{
                An example of surface affected by defects of class \#4 is shown in figure \ref{fig:defects:surface-4}. A single defect of class \#4 (i.e. a single crack) has usually the shape shown in picture \ref{fig:defects:shape-4}.
            }
            \par{
                Defect \#4 dimensions distribution is shown in \ref{fig:defects:gaussian-4}. 
            }
            \begin{table}
                \centering
                \begin{tabular}{|c|c|c|}
                    \hline
                    \textbf{Length distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/lengthDistribution4.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                    \textbf{Height distribution} & $p$-value & Null hypothesis rejected
                    \csvreader[head to column names]{data/heightDistribution4.csv}{}% use head of csv as column names
                    {\\\hline\Distribution&\pValue&\h}% specify your coloumns here
                    \\\hline
                \end{tabular}
                \vspace{0.25cm}
                \caption{hypotheses test results on class \#4.}\label{table:hypotheses-test-4}
            \end{table}
            \par{
                In table \ref{table:hypotheses-test-4} are shown the results of some distribution hypothesis tests. Conclusions are the same discussed in \ref{section:defect-class-1}.
            }
            \begin{figure}
                \centering
                \includegraphics[width=\linewidth]{graphics/defects/nregions-class4}
                \caption{Number of defects of class 4 per defective surface.}\label{fig:nregions-4}
            \end{figure}
            \par{
                Even this defect class has global characteristics, as confirmed by the histogram in picture \ref{fig:nregions-4}.
            }
    \subsection{Dataset considerations}
        \begin{figure}
            \includegraphics[width=\linewidth]{graphics/defects/representation}
            \caption{Class representation in the original dataset.}\label{fig:defects:representation-original}
        \end{figure}
        \par{
            The dataset is composed by images linked to up to four strings of RLE encoded pixels, one per defect class.
        }
        \par{
            In illustration \ref{fig:defects:representation-original} the relative representation of the classes in the original dataset is shown. It is patent that class 3 is far more represented then the other defect classes, and the number of surfaces with at least a defect of this class is nearly tantamount the number of flawless surfaces.
        }
        \begin{figure}
            \includegraphics[width=\linewidth]{graphics/defects/combinations}
            \caption{Frequencies of defects combinations.}\label{fig:defects:combinations}
        \end{figure}
        \par{
            In figure \ref{fig:defects:combinations} images have been grouped in mutually exclusive subsets, based on the combination of defects in the pictured surface.
        }
        \par{
            Since skewed dataset lessen the effectiveness of machine learning algorithms, especially in predicting minority class examples, data augmentation is done only on those classes or combinations of classes with fewer elements.
        }
        \begin{figure}
            \includegraphics[width=\linewidth]{graphics/defects/data-augmentation}
            \vskip .05cm
            \includegraphics[width=\linewidth]{graphics/defects/data-augmentation-h}
            \vskip .05cm
            \includegraphics[width=\linewidth]{graphics/defects/data-augmentation-v}
            \vskip .05cm
            \includegraphics[width=\linewidth]{graphics/defects/data-augmentation-hv}
            \caption{Data augmentation. The image is flipped horizontally, vertically and both. The defective area is moved coherently.}\label{fig:data-augmentation}
        \end{figure}
        \par{
            In order to keep proper proportions and spatial information, replicas of surfaces are built only using simmetries. Therefore, from a single image other three are generated. An example of such operation is shown in \ref{fig:data-augmentation}.
        }
        \par{
            The encoded defective pixels must be mapped onto the new image. This can be easily done considering the binary matrix corresponding to the encoded pixels, flipping it and re-encoding the resulting map.
        }
        \begin{figure}
            \includegraphics[width=\linewidth]{graphics/defects/representation-augmented}
            \caption{Class representation in the augmented dataset.}\label{fig:defects:representation-augmented}
        \end{figure}
        \par{
            The resulting dataset is slightly more balanced. The bar chart in figure \ref{fig:defects:representation-augmented} shows the new representation of the different classes after data augmentation.
        }